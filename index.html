<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Start Pilot — Prototype</title>
<style>
  :root{
    --orange:#F5C77C; /* sampled from your image */
    --bg:#f2f3f5;
    --card:#fff;
    --muted:#666;
    --maxw:1180px;
    --radius:10px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, sans-serif; margin:0; background:var(--bg); color:#111;}
  header{background:var(--orange); color:white; padding:12px 16px; display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:10;}
  header .logo{display:flex; align-items:center; gap:10px; cursor:pointer;}
  header .logo img{height:36px; user-select:none;}
  .container{max-width:var(--maxw); margin:18px auto; padding:0 12px;}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:0 2px 6px rgba(0,0,0,0.07); padding:16px;}
  .grid{display:grid; grid-template-columns:260px 1fr 300px; gap:16px;}
  .left,.center,.right{min-height:200px;}
  .left .item, .right .item{margin-bottom:12px;}
  .btn{background:var(--orange); color:white; padding:8px 12px; border:none; border-radius:8px; cursor:pointer;}
  .btn.ghost{background:transparent; color:var(--orange); border:1px solid rgba(255,255,255,0.3);}
  .form-row{display:flex; gap:8px; margin-bottom:8px;}
  input[type=text], input[type=password], input[type=date], textarea, select{padding:8px; border-radius:8px; border:1px solid #ddd; width:100%;}
  textarea{min-height:80px; resize:vertical;}
  .small{font-size:13px; color:var(--muted);}
  .hidden{display:none;}
  .profile-brief{display:flex; align-items:center; gap:10px;}
  .avatar{width:56px; height:56px; border-radius:50%; background:#ddd; display:inline-block; overflow:hidden;}
  .avatar img{width:100%; height:100%; object-fit:cover;}
  .post{border:1px solid #eee; padding:10px; border-radius:8px; margin-bottom:10px; background:#fff;}
  .post .meta{display:flex; align-items:center; gap:10px; margin-bottom:8px;}
  .row{display:flex; gap:8px; align-items:center;}
  .pill{background:#f7f7f7; padding:6px 8px; border-radius:999px; font-size:13px;}
  .nav-item{padding:8px 10px; border-radius:8px; cursor:pointer;}
  .nav-item:hover{background:#f5f5f5;}
  .notif-dot{width:10px; height:10px; background:#e53935; border-radius:50%; display:inline-block; margin-left:6px;}
  .muted{color:var(--muted);}
  .center .create-post{margin-bottom:12px;}
  .group-card{border:1px dashed #eee; padding:8px; border-radius:8px; margin-bottom:8px;}
  .friend-row{display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-radius:8px;}
  .friend-row:hover{background:#fbfbfb;}
  .search{display:flex; gap:8px; margin-bottom:10px;}
  .top-actions{display:flex; gap:8px; align-items:center;}
  .linkish{color:var(--orange); cursor:pointer; text-decoration:underline;}
  .center-area{padding:0 6px;}
  footer{padding:18px; text-align:center; color:var(--muted);}
  /* small responsive */
  @media(max-width:980px){
    .grid{grid-template-columns:1fr; }
    .right{order:3}
  }
</style>
</head>
<body>

<header>
  <div class="logo" id="logo">
    <!-- Embedded logo (base64) -->
    <img id="logoImg" src="data:image/jpeg;base64,/*BASE64_LOGO*/" alt="Start Pilot logo" />
    <div style="font-weight:700; font-size:20px;">Start Pilot</div>
  </div>
  <div class="spacer" style="flex:1"></div>
  <div id="headerRight"></div>
</header>

<div class="container" id="app">
  <!-- SPA will render here -->
</div>

<footer>
  Prototype — data saved to your browser only.
</footer>

<script>
/* ========= Embedded logo base64 is injected below automatically by generator.
   If you edit the file manually, keep the src data URI intact. */
const logoDataURI = document.getElementById('logoImg').src;

/* ======= Basic storage keys and helpers ======= */
const STORAGE_KEY = 'startpilot_v1';
const SAVED_CRED_KEY = 'startpilot_saved_creds';

function loadState(){
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch(e){ return {};}
}
function saveState(state){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function saveCreds(creds){
  localStorage.setItem(SAVED_CRED_KEY, JSON.stringify(creds));
}
function loadCreds(){ try{return JSON.parse(localStorage.getItem(SAVED_CRED_KEY) || 'null');}catch(e){return null} }

/* ======= Initialize state if missing ======= */
let state = loadState();
if(!state.users) state = { users: {}, posts: [], groups: {}, messages: {} };
saveState(state);

/* ======= Simple bad-words list (extendable) ======= */
const BAD_WORDS = ['badword','cuss','inappropriate']; // add more

function containsBadWord(text){
  if(!text) return false;
  const s = text.toLowerCase();
  return BAD_WORDS.some(w => s.includes(w));
}

/* ======= Auth helpers ======= */
let currentUser = null; // username
function signup(username, password){
  username = username.trim().toLowerCase();
  if(!username) return {ok:false, msg:'Username required'};
  if(containsBadWord(username)) return {ok:false, msg:'Username contains inappropriate words'};
  if(state.users[username]) return {ok:false, msg:'Username already taken'};
  if(password.length <=5 || password.length >=20) return {ok:false, msg:'Password must be 6-19 characters'};
  if(!(/[A-Za-z]/.test(password) && /[0-9]/.test(password))) return {ok:false, msg:'Password must include letters and numbers'};
  // create
  state.users[username] = {
    username, password,
    meta: { profileName:'', firstName:'', lastName:'', birthday:'', avatar:null, friends:[], friendRequests:[], loginCount:0 },
    posts: [],
    groups: []
  };
  saveState(state);
  return {ok:true};
}

function login(username, password, remember=false){
  username = username.trim().toLowerCase();
  const u = state.users[username];
  if(!u) return {ok:false, msg:'No account with that username'};
  if(u.password !== password) return {ok:false, msg:'Wrong password'};
  // increment login count
  u.meta.loginCount = (u.meta.loginCount || 0) + 1;
  saveState(state);
  currentUser = username;
  if(remember){
    saveCreds({username, password});
  }
  // if loginCount >=3 set autoLogin flag in saved creds
  if(u.meta.loginCount >= 3){
    saveCreds({username, password, auto:true});
  }
  return {ok:true};
}

function logout(){
  currentUser = null;
  renderApp();
}

/* ======= Utility render helpers ======= */
const appRoot = document.getElementById('app');
const headerRight = document.getElementById('headerRight');
document.getElementById('logo').addEventListener('click', ()=>{
  // only clickable when logged in
  if(currentUser) renderApp();
});

/* ======= Auto-login on load if saved creds & auto flag ======= */
(function tryAutoLogin(){
  const creds = loadCreds();
  if(creds && creds.auto){
    // try to log in automatically if user still exists with same password
    if(state.users[creds.username] && state.users[creds.username].password === creds.password){
      currentUser = creds.username;
    } else {
      // invalid saved creds; clear
      localStorage.removeItem(SAVED_CRED_KEY);
    }
  }
})();

/* ======= Rendering: Login / Signup Pages ======= */
function renderAuth(){
  headerRight.innerHTML = '';
  appRoot.innerHTML = `
    <div style="display:flex; gap:24px; align-items:stretch; justify-content:center; flex-wrap:wrap;">
      <div class="card" style="width:420px;">
        <h2>Welcome to Start Pilot</h2>
        <p class="small">Sign in to continue</p>
        <div id="signinMsg" class="small muted"></div>
        <div style="margin-top:8px;">
          <label>Username</label><input id="loginUser" type="text" />
          <label>Password</label><input id="loginPass" type="password" />
          <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
            <button class="btn" id="loginBtn">Log In</button>
            <label class="small"><input type="checkbox" id="saveCred"> Save username & password</label>
          </div>
          <div style="margin-top:6px;">
            <a id="toSignup" class="linkish">Create a new account</a>
          </div>
        </div>
      </div>
      <div class="card" style="width:420px;">
        <h3>Create account</h3>
        <div id="signupMsg" class="small muted"></div>
        <label>Username</label><input id="suUser" type="text" />
        <label>Password</label><input id="suPass" type="password" />
        <label>Confirm password</label><input id="suPass2" type="password" />
        <div style="margin-top:8px;"><button class="btn" id="signupBtn">Sign up</button></div>
        <div class="small muted" style="margin-top:8px;">
          Username can't contain inappropriate words. Password 6-19 chars, must include letters & numbers.
        </div>
      </div>
    </div>
  `;
  // Try prefill saved creds
  const saved = loadCreds();
  if(saved){
    const elU = document.getElementById('loginUser');
    const elP = document.getElementById('loginPass');
    if(saved.username) elU.value = saved.username;
    if(saved.password) elP.value = saved.password;
  }

  document.getElementById('toSignup').addEventListener('click', renderAuthSignup);
  document.getElementById('signupBtn').addEventListener('click', ()=>{
    const u = document.getElementById('suUser').value;
    const p = document.getElementById('suPass').value;
    const p2 = document.getElementById('suPass2').value;
    const msg = document.getElementById('signupMsg');
    if(p !== p2){ msg.textContent='Passwords do not match'; return; }
    const res = signup(u,p);
    if(!res.ok){ msg.textContent = res.msg; return; }
    msg.textContent = 'Account created! You can log in now.';
  });

  document.getElementById('loginBtn').addEventListener('click', ()=>{
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    const save = document.getElementById('saveCred').checked;
    const msg = document.getElementById('signinMsg');
    const res = login(u,p,save);
    if(!res.ok){ msg.textContent = res.msg; return; }
    // after login, if user hasn't completed profile, send to setup
    const meta = state.users[currentUser].meta;
    if(!meta.profileName || !meta.firstName || !meta.lastName || !meta.birthday){
      renderProfileSetup();
    } else {
      renderApp();
    }
  });
}

function renderAuthSignup(){
  // simple switch to the signup area (same as renderAuth for now)
  renderAuth();
}

/* ======= Profile setup ======= */
function renderProfileSetup(){
  headerRight.innerHTML = '';
  appRoot.innerHTML = `
    <div class="card" style="max-width:640px; margin:20px auto;">
      <h2>Set up your profile</h2>
      <p class="small">Enter the info to complete your account</p>
      <label>Profile name</label><input id="pfProfileName" type="text" />
      <label>First name</label><input id="pfFirst" type="text" />
      <label>Last name</label><input id="pfLast" type="text" />
      <label>Birthday</label><input id="pfBday" type="date" />
      <div style="margin-top:8px;">
        <label>Profile photo (optional)</label><input id="pfAvatar" type="file" accept="image/*" />
      </div>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button class="btn" id="pfDone" disabled>Done</button>
        <button class="btn ghost" id="pfSkip">Skip</button>
      </div>
      <div class="small muted" style="margin-top:8px;">You can edit this later in your profile page.</div>
    </div>
  `;
  // prefill if any
  const meta = state.users[currentUser].meta;
  document.getElementById('pfProfileName').value = meta.profileName || '';
  document.getElementById('pfFirst').value = meta.firstName || '';
  document.getElementById('pfLast').value = meta.lastName || '';
  document.getElementById('pfBday').value = meta.birthday || '';

  function checkEnable(){
    const p = document.getElementById('pfProfileName').value.trim();
    const f = document.getElementById('pfFirst').value.trim();
    const l = document.getElementById('pfLast').value.trim();
    const b = document.getElementById('pfBday').value;
    document.getElementById('pfDone').disabled = !(p && f && l && b);
  }
  ['pfProfileName','pfFirst','pfLast','pfBday'].forEach(id=>{
    document.getElementById(id).addEventListener('input', checkEnable);
  });
  document.getElementById('pfDone').addEventListener('click', async ()=>{
    const profileName = document.getElementById('pfProfileName').value.trim();
    const first = document.getElementById('pfFirst').value.trim();
    const last = document.getElementById('pfLast').value.trim();
    const bday = document.getElementById('pfBday').value;
    // avatar handling
    const f = document.getElementById('pfAvatar').files[0];
    if(f && f.size > 500000){ alert('Image too large (limit 500KB)'); return;}
    let avatar = state.users[currentUser].meta.avatar || null;
    if(f){
      const data = await fileToDataURL(f);
      avatar = data;
    }
    // save meta
    state.users[currentUser].meta = {...state.users[currentUser].meta, profileName, firstName:first, lastName:last, birthday:bday, avatar};
    saveState(state);
    renderApp();
  });
  document.getElementById('pfSkip').addEventListener('click', ()=>{
    renderApp();
  });
}

/* ======= File helper ======= */
function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* ======= Main App (Home) ======= */
function renderApp(){
  // if not logged in, show auth
  if(!currentUser){ renderAuth(); return; }

  headerRight.innerHTML = `
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="small muted">Hi, ${state.users[currentUser].meta.profileName || currentUser}</div>
      <div style="width:44px; cursor:pointer;" id="hdrAvatar"></div>
    </div>
  `;
  const avatarEl = document.getElementById('hdrAvatar');
  const meta = state.users[currentUser].meta;
  avatarEl.innerHTML = `<div class="avatar">${meta.avatar ? '<img src="'+meta.avatar+'"/>' : ''}</div>`;
  avatarEl.addEventListener('click', ()=> renderProfilePage(currentUser));

  // compose main layout
  appRoot.innerHTML = `
    <div class="grid">
      <div class="left">
        <div class="card">
          <h4>Feed</h4>
          <div class="search">
            <input placeholder="Search friends or groups" id="searchBox"/>
            <button class="btn" id="searchBtn">Search</button>
          </div>
          <div id="leftFeed"></div>
        </div>
      </div>
      <div class="center">
        <div class="card center-area">
          <div class="top-actions">
            <button class="btn" id="newPostBtn">Create Post</button>
            <button class="btn ghost" id="createGroupBtn">Create Group</button>
            <div style="flex:1"></div>
            <button class="btn ghost" id="logoutBtn">Log out</button>
          </div>
          <div id="postComposer" class="create-post hidden" style="margin-top:12px;">
            <textarea id="postText" placeholder="What's happening?"></textarea>
            <div style="margin-top:6px;">
              <label class="small">Image (optional)</label> <input id="postImage" type="file" accept="image/*" />
            </div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <select id="postPrivacy"><option value="public">Public</option><option value="private">Only me</option><option value="group">Post to group</option></select>
              <select id="postGroupSelect" class="hidden"></select>
              <button class="btn" id="submitPost">Post</button>
              <button class="btn ghost" id="cancelPost">Cancel</button>
            </div>
            <div id="postMsg" class="small muted"></div>
          </div>
          <div id="feedArea" style="margin-top:12px;"></div>
        </div>
      </div>
      <div class="right">
        <div class="card">
          <h4>Your Friends</h4>
          <div id="friendList"></div>
          <hr/>
          <h4>Requests</h4>
          <div id="reqList"></div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <h4>Groups</h4>
          <div id="groupList"></div>
        </div>
      </div>
    </div>
  `;

  // attach actions
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    logout();
  });
  document.getElementById('newPostBtn').addEventListener('click', ()=>{
    document.getElementById('postComposer').classList.toggle('hidden');
  });
  document.getElementById('createGroupBtn').addEventListener('click', createGroupDialog);
  document.getElementById('cancelPost').addEventListener('click', ()=>{ document.getElementById('postComposer').classList.add('hidden'); });
  document.getElementById('submitPost').addEventListener('click', submitPostHandler);
  document.getElementById('postGroupSelect').addEventListener('change', ()=>{});

  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const q = document.getElementById('searchBox').value.trim().toLowerCase();
    if(!q) renderApp(); else searchUsersAndGroups(q);
  });

  renderFriendList();
  renderRequests();
  renderGroups();
  renderFeed();
}

/* ======= Friends and requests ======= */
function renderFriendList(){
  const el = document.getElementById('friendList');
  el.innerHTML = '';
  const meta = state.users[currentUser].meta;
  if(!meta.friends || meta.friends.length===0){
    el.innerHTML = '<div class="small muted">No friends yet</div>';
    return;
  }
  meta.friends.forEach(u=>{
    const row = document.createElement('div');
    row.className='friend-row';
    row.innerHTML = `<div style="display:flex;gap:8px;align-items:center;"><div class="avatar" style="width:36px;height:36px">${state.users[u].meta.avatar?'<img src="'+state.users[u].meta.avatar+'"/>':''}</div><div><div style="font-weight:600">${state.users[u].meta.profileName || u}</div><div class="small muted">${state.users[u].meta.firstName || ''} ${state.users[u].meta.lastName || ''}</div></div></div><div><button class="btn ghost" data-user="${u}" onclick="renderProfilePage('${u}')">View</button></div>`;
    el.appendChild(row);
  });
}

function renderRequests(){
  const el = document.getElementById('reqList');
  el.innerHTML = '';
  const pending = state.users[currentUser].meta.friendRequests || [];
  if(pending.length===0){ el.innerHTML = '<div class="small muted">No requests</div>'; return; }
  pending.forEach(u=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='6px 0';
    div.innerHTML = `<div>${state.users[u].meta.profileName || u}</div><div><button class="btn" onclick="acceptFriend('${u}')">Accept</button> <button class="btn ghost" onclick="rejectFriend('${u}')">Reject</button></div>`;
    el.appendChild(div);
  });
}
window.acceptFriend = function(fromUser){
  // add each other
  if(!state.users[currentUser].meta.friends.includes(fromUser)) state.users[currentUser].meta.friends.push(fromUser);
  if(!state.users[fromUser].meta.friends.includes(currentUser)) state.users[fromUser].meta.friends.push(currentUser);
  // remove request
  state.users[currentUser].meta.friendRequests = (state.users[currentUser].meta.friendRequests||[]).filter(x=>x!==fromUser);
  saveState(state);
  renderApp();
};
window.rejectFriend = function(fromUser){
  state.users[currentUser].meta.friendRequests = (state.users[currentUser].meta.friendRequests||[]).filter(x=>x!==fromUser);
  saveState(state);
  renderApp();
};

function sendFriendRequest(toUser){
  if(!state.users[toUser]) return alert('No user found');
  const target = state.users[toUser];
  if(target.meta.friendRequests && target.meta.friendRequests.includes(currentUser)) return alert('Request already sent');
  if(target.meta.friends && target.meta.friends.includes(currentUser)) return alert('Already friends');
  target.meta.friendRequests = target.meta.friendRequests || [];
  target.meta.friendRequests.push(currentUser);
  saveState(state);
  alert('Friend request sent');
  renderApp();
}

/* ======= Groups ======= */
function createGroupDialog(){
  const name = prompt('Group name (2-25 chars):');
  if(!name) return;
  if(name.length <2 || name.length>25){ alert('Group name must be 2-25 chars'); return; }
  const slug = 'g_'+Date.now();
  state.groups[slug] = { id:slug, name, admin:currentUser, members:[currentUser], posts:[], joinRequests:[] };
  state.users[currentUser].groups = state.users[currentUser].groups || [];
  state.users[currentUser].groups.push(slug);
  saveState(state);
  renderApp();
}
function renderGroups(){
  const el = document.getElementById('groupList');
  el.innerHTML = '';
  const groups = Object.values(state.groups);
  if(groups.length===0){ el.innerHTML = '<div class="small muted">No groups yet</div>'; return; }
  groups.forEach(g=>{
    const div = document.createElement('div');
    div.className='group-card';
    const memberCount = (g.members||[]).length;
    const isMember = g.members.includes(currentUser);
    div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
      <div><strong>${g.name}</strong><div class="small muted">${memberCount} members</div></div>
      <div>${isMember?'<button class="btn ghost" onclick="openGroup(\\'${g.id}\\')">Open</button>':'<button class="btn" onclick="requestJoin(\\''+g.id+'\\')">Join</button>'}</div>
    </div>`;
    // replace escaped quotes
    div.innerHTML = div.innerHTML.replace(/\\\\'/g, "'");
    el.appendChild(div);
  });
}
window.requestJoin = function(groupId){
  const g = state.groups[groupId];
  if(!g) return alert('Group not found');
  if(g.members.includes(currentUser)) return alert('Already member');
  if(g.joinRequests.includes(currentUser)) return alert('Join request already sent');
  g.joinRequests.push(currentUser);
  saveState(state);
  alert('Join request sent to admin');
  renderApp();
}
window.openGroup = function(groupId){
  const g = state.groups[groupId];
  if(!g) return alert('Not found');
  // show group page (simple)
  appRoot.innerHTML = `
    <div class="card" style="max-width:900px; margin:20px auto;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><h2>${g.name}</h2><div class="small muted">${g.members.length} members — admin: ${g.admin}</div></div>
        <div><button class="btn" id="backHome">Back</button></div>
      </div>
      <div style="margin-top:12px;">
        <div id="groupActions"></div>
        <div style="margin-top:10px;">
          <textarea id="groupPostText" placeholder="Post to group (members only)"></textarea>
          <div style="margin-top:8px;"><button class="btn" id="groupPostBtn">Post</button></div>
        </div>
        <div style="margin-top:12px;" id="groupPosts"></div>
      </div>
    </div>
  `;
  document.getElementById('backHome').addEventListener('click', renderApp);
  function renderActions(){
    const actions = document.getElementById('groupActions');
    actions.innerHTML = '';
    if(g.admin === currentUser){
      actions.innerHTML = '<div class="small muted">You are admin. Approve join requests below.</div>';
      if(g.joinRequests.length){
        g.joinRequests.forEach(req=>{
          const d = document.createElement('div');
          d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center';
          d.innerHTML = `<div>${req}</div><div><button class="btn" onclick="approveJoin('${groupId}','${req}')">Approve</button> <button class="btn ghost" onclick="denyJoin('${groupId}','${req}')">Deny</button></div>`;
          actions.appendChild(d);
        });
      }
    } else {
      if(g.members.includes(currentUser)){
        actions.innerHTML = '<div class="small muted">Member of this group</div>';
      } else {
        actions.innerHTML = '<div class="small muted">You are not a member of this group.</div>';
      }
    }
  }
  renderActions();
  document.getElementById('groupPostBtn').addEventListener('click', ()=>{
    if(!g.members.includes(currentUser)) return alert('Only group members can post');
    const txt = document.getElementById('groupPostText').value.trim();
    if(!txt) return alert('Write something');
    if(containsBadWord(txt)) return alert('Message contains inappropriate words');
    const post = {id:'p_'+Date.now(), author:currentUser, text:txt, image:null, privacy:'group', groupId, hearts:[], comments:[], ts:Date.now()};
    g.posts.unshift(post);
    saveState(state);
    renderGroupPosts();
  });
  renderGroupPosts();
}
window.approveJoin = function(groupId, userId){
  const g = state.groups[groupId];
  if(!g) return;
  if(!g.joinRequests.includes(userId)) return;
  g.joinRequests = g.joinRequests.filter(x=>x!==userId);
  if(!g.members.includes(userId)) g.members.push(userId);
  state.users[userId].groups = state.users[userId].groups || [];
  state.users[userId].groups.push(groupId);
  saveState(state);
  openGroup(groupId);
}
window.denyJoin = function(groupId, userId){
  const g = state.groups[groupId];
  if(!g) return;
  g.joinRequests = g.joinRequests.filter(x=>x!==userId);
  saveState(state);
  openGroup(groupId);
}
function renderGroupPosts(){
  const gp = document.getElementById('groupPosts');
  const g = state.groups[Object.keys(state.groups).find(k=>k===Object.keys(state.groups).find(x=>true))]; // not used
  // re-open page by calling openGroup again would re-render. Simpler: reload app.
  renderApp();
}

/* ======= Posting ======= */
async function submitPostHandler(){
  const txt = document.getElementById('postText').value.trim();
  const file = document.getElementById('postImage').files[0];
  const privacy = document.getElementById('postPrivacy').value;
  const postMsg = document.getElementById('postMsg');
  if(!txt && !file){ postMsg.textContent='Please add text or image'; return; }
  if(containsBadWord(txt)) { postMsg.textContent='Post contains inappropriate words'; return; }
  let imgData = null;
  if(file){
    if(file.size > 500000){ postMsg.textContent='Image too large (max 500KB)'; return; }
    imgData = await fileToDataURL(file);
  }
  if(privacy === 'group'){
    // group posting: pick first group user is member of for demo; else blocked
    const groups = (state.users[currentUser].groups||[]);
    if(groups.length===0){ postMsg.textContent='You must join a group to post to a group'; return; }
    const groupId = groups[0];
    const g = state.groups[groupId];
    g.posts = g.posts || [];
    g.posts.unshift({id:'gp_'+Date.now(), author:currentUser, text:txt, image:imgData, ts:Date.now(), hearts:[], comments:[]});
    saveState(state);
    document.getElementById('postText').value=''; document.getElementById('postImage').value='';
    postMsg.textContent='Posted to group';
    renderApp();
    return;
  } else {
    const post = { id:'p_'+Date.now(), author:currentUser, text:txt, image:imgData, privacy, hearts:[], comments:[], ts:Date.now() };
    state.posts.unshift(post);
    state.users[currentUser].posts = state.users[currentUser].posts || [];
    state.users[currentUser].posts.unshift(post.id);
    saveState(state);
    document.getElementById('postText').value=''; document.getElementById('postImage').value='';
    document.getElementById('postComposer').classList.add('hidden');
    renderFeed();
  }
}

function renderFeed(){
  const el = document.getElementById('feedArea');
  el.innerHTML = '';
  // Show posts: public posts from anyone + private posts from currentUser + group posts for groups user is member of
  const feed = [];
  // public & own private
  state.posts.forEach(p=>{
    if(p.privacy === 'public') feed.push(p);
    if(p.privacy === 'private' && p.author === currentUser) feed.push(p);
  });
  // group posts where member
  Object.values(state.groups).forEach(g=>{
    if(g.members && g.members.includes(currentUser)){
      (g.posts||[]).forEach(p=>{
        feed.push({...p, isGroup:true, groupName:g.name});
      });
    }
  });
  // sort by ts desc
  feed.sort((a,b)=> (b.ts||0) - (a.ts||0));
  if(feed.length===0){ el.innerHTML = '<div class="small muted">No posts yet</div>'; return; }
  feed.forEach(p=>{
    const d = document.createElement('div');
    d.className='post';
    d.innerHTML = `
      <div class="meta">
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="avatar" style="width:40px;height:40px">${state.users[p.author].meta.avatar?'<img src="'+state.users[p.author].meta.avatar+'"/>':''}</div>
          <div><div style="font-weight:600">${state.users[p.author].meta.profileName || p.author} ${p.isGroup?'<span class="pill">'+p.groupName+'</span>':''}</div><div class="small muted">${new Date(p.ts).toLocaleString()}</div></div>
        </div>
      </div>
      <div style="margin-top:8px;">${escapeHtml(p.text||'')}</div>
      ${p.image?'<div style="margin-top:8px;"><img src="'+p.image+'" style="max-width:100%; border-radius:8px;"/></div>':''}
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <button class="btn ghost" data-id="${p.id}" onclick="toggleHeart('${p.id}')">❤ <span id="heartCount_${p.id}">${(p.hearts||[]).length}</span></button>
        <button class="btn ghost" onclick="openComments('${p.id}')">Comment</button>
        ${p.author === currentUser ? '<button class="btn ghost" onclick="deletePost(\\''+p.id+'\\')">Delete</button>' : '<button class="btn ghost" onclick="startMessage(\\''+p.author+'\\')">Message</button>'}
      </div>
      <div id="comments_${p.id}" style="margin-top:8px;"></div>
    `;
    d.innerHTML = d.innerHTML.replace(/\\\\'/g, "'");
    el.appendChild(d);
    // comments list
    renderComments(p.id);
  });
}

/* ======= Hearts, comments, delete ======= */
window.toggleHeart = function(postId){
  // find post in state.posts or in groups
  let p = state.posts.find(x=>x.id===postId);
  if(!p){
    for(const g of Object.values(state.groups)){
      const found = (g.posts||[]).find(x=>x.id===postId);
      if(found){ p=found; break;}
    }
  }
  if(!p) return;
  p.hearts = p.hearts || [];
  if(p.hearts.includes(currentUser)){
    p.hearts = p.hearts.filter(x=>x!==currentUser);
  } else {
    p.hearts.push(currentUser);
  }
  saveState(state);
  const el = document.getElementById('heartCount_'+postId);
  if(el) el.textContent = p.hearts.length;
};
window.openComments = function(postId){
  const el = document.getElementById('comments_'+postId);
  el.innerHTML = '<div style="margin-top:6px;"><input id="c_'+postId+'" placeholder="Write a comment..." style="width:80%"/><button class="btn" onclick="submitComment(\\''+postId+'\\')">Reply</button></div>';
  el.innerHTML = el.innerHTML.replace(/\\\\'/g, "'");
};
window.submitComment = function(postId){
  const input = document.getElementById('c_'+postId);
  if(!input) return;
  const text = input.value.trim();
  if(!text) return;
  if(containsBadWord(text)) return alert('Comment contains inappropriate words');
  let p = state.posts.find(x=>x.id===postId);
  if(!p){
    for(const g of Object.values(state.groups)){
      const found = (g.posts||[]).find(x=>x.id===postId);
      if(found){ p=found; break;}
    }
  }
  if(!p) return;
  p.comments = p.comments || [];
  p.comments.push({author:currentUser, text, ts:Date.now()});
  saveState(state);
  renderComments(postId);
};
function renderComments(postId){
  const el = document.getElementById('comments_'+postId);
  if(!el) return;
  let p = state.posts.find(x=>x.id===postId);
  if(!p){
    for(const g of Object.values(state.groups)){
      const found = (g.posts||[]).find(x=>x.id===postId);
      if(found){ p=found; break;}
    }
  }
  if(!p) { el.innerHTML=''; return;}
  let html = '';
  (p.comments||[]).forEach(c=>{
    html += `<div class="small"><strong>${state.users[c.author].meta.profileName||c.author}</strong> ${escapeHtml(c.text)}</div>`;
  });
  html += `<div style="margin-top:6px;"><input id="c_${postId}" placeholder="Write a comment..." style="width:80%"/><button class="btn" onclick="submitComment('${postId}')">Reply</button></div>`;
  el.innerHTML = html;
}
window.deletePost = function(postId){
  // remove from global posts
  state.posts = state.posts.filter(x=>x.id!==postId);
  for(const g of Object.values(state.groups)){ g.posts = (g.posts||[]).filter(x=>x.id!==postId); }
  for(const u of Object.values(state.users)){ u.posts = (u.posts||[]).filter(x=>x!==postId); }
  saveState(state);
  renderApp();
}

/* ======= Profile page ======= */
function renderProfilePage(username){
  if(!state.users[username]) return alert('User not found');
  const u = state.users[username];
  appRoot.innerHTML = `
    <div style="max-width:900px; margin:20px auto;">
      <div class="card" style="display:flex; gap:16px; align-items:center;">
        <div class="avatar" style="width:86px;height:86px">${u.meta.avatar?'<img src="'+u.meta.avatar+'"/>':''}</div>
        <div>
          <h2>${u.meta.profileName || username}</h2>
          <div class="small muted">${u.meta.firstName||''} ${u.meta.lastName||''}</div>
          <div class="small muted">Birthday: ${u.meta.birthday || 'N/A'}</div>
          <div style="margin-top:8px;">
            ${username === currentUser ? '<button class="btn" id="editProfileBtn">Edit Profile</button> <button class="btn ghost" id="deleteAccountBtn">Delete Account</button>' : '<button class="btn" id="friendActionBtn"></button> <button class="btn ghost" id="messageBtn">Message</button>'}
            <button class="btn ghost" id="backBtn">Back</button>
          </div>
        </div>
        <div style="margin-left:auto; text-align:right;">
          <div><strong>${(u.meta.friends||[]).length}</strong></div>
          <div class="small muted">friends</div>
        </div>
      </div>
      <div style="margin-top:12px;" id="profilePosts"></div>
    </div>
  `;
  document.getElementById('backBtn').addEventListener('click', renderApp);
  if(username === currentUser){
    document.getElementById('editProfileBtn').addEventListener('click', ()=>{ renderEditProfile(); });
    document.getElementById('deleteAccountBtn').addEventListener('click', ()=>{ if(confirm('Delete account? This cannot be undone.')) deleteAccount(); });
  } else {
    const btn = document.getElementById('friendActionBtn');
    const isFriend = state.users[currentUser].meta.friends.includes(username);
    btn.textContent = isFriend ? 'Friends' : 'Add Friend';
    btn.addEventListener('click', ()=>{ if(!isFriend) sendFriendRequest(username); else alert('Already friends'); });
    document.getElementById('messageBtn').addEventListener('click', ()=> startMessage(username));
  }
  renderProfilePosts(username);
}

function renderEditProfile(){
  const meta = state.users[currentUser].meta;
  appRoot.innerHTML = `
    <div style="max-width:640px; margin:20px auto;">
      <div class="card">
        <h3>Edit profile</h3>
        <label>Profile name</label><input id="eProfileName" value="${meta.profileName||''}"/>
        <label>First name</label><input id="eFirst" value="${meta.firstName||''}"/>
        <label>Last name</label><input id="eLast" value="${meta.lastName||''}"/>
        <label>Birthday</label><input id="eBday" type="date" value="${meta.birthday||''}"/>
        <label>Change avatar</label><input id="eAvatar" type="file" accept="image/*"/>
        <div style="margin-top:12px;"><button class="btn" id="saveProfileBtn">Save</button> <button class="btn ghost" id="cancelEdit">Cancel</button></div>
      </div>
    </div>
  `;
  document.getElementById('cancelEdit').addEventListener('click', ()=> renderProfilePage(currentUser));
  document.getElementById('saveProfileBtn').addEventListener('click', async ()=>{
    const profileName = document.getElementById('eProfileName').value.trim();
    const first = document.getElementById('eFirst').value.trim();
    const last = document.getElementById('eLast').value.trim();
    const bday = document.getElementById('eBday').value;
    const f = document.getElementById('eAvatar').files[0];
    let avatar = state.users[currentUser].meta.avatar || null;
    if(f){
      if(f.size > 500000){ alert('Image too large'); return; }
      avatar = await fileToDataURL(f);
    }
    state.users[currentUser].meta = {...state.users[currentUser].meta, profileName, firstName:first, lastName:last, birthday:bday, avatar};
    saveState(state);
    renderProfilePage(currentUser);
  });
}

function deleteAccount(){
  // remove user and references
  delete state.users[currentUser];
  // remove from friends lists and groups
  for(const u of Object.keys(state.users)){
    const list = state.users[u].meta.friends || [];
    state.users[u].meta.friends = list.filter(x=>x!==currentUser);
  }
  for(const g of Object.values(state.groups)){
    g.members = (g.members||[]).filter(x=>x!==currentUser);
    g.joinRequests = (g.joinRequests||[]).filter(x=>x!==currentUser);
    if(g.admin === currentUser){
      if(g.members.length>0) g.admin = g.members[0];
      else delete state.groups[g.id];
    }
  }
  saveState(state);
  localStorage.removeItem(SAVED_CRED_KEY);
  currentUser = null;
  renderAuth();
}

function renderProfilePosts(username){
  const el = document.getElementById('profilePosts');
  el.innerHTML = '<div class="card"><h4>Posts</h4></div>';
  const posts = [];
  // collect from global posts and groups
  state.posts.forEach(p=>{ if(p.author === username) posts.push(p); });
  Object.values(state.groups).forEach(g=>{
    (g.posts||[]).forEach(p=>{ if(p.author === username) posts.push({...p, isGroup:true, groupName:g.name}); });
  });
  posts.sort((a,b)=> (b.ts||0)-(a.ts||0));
  const container = document.createElement('div');
  container.className='card';
  posts.forEach(p=>{
    const div = document.createElement('div');
    div.className='post';
    div.innerHTML = `<div><strong>${state.users[p.author].meta.profileName||p.author}</strong> <span class="small muted">${new Date(p.ts).toLocaleString()}</span></div><div style="margin-top:6px;">${escapeHtml(p.text)}</div>${p.image?'<div style="margin-top:8px"><img src="'+p.image+'" style="max-width:100%; border-radius:8px;"/></div>':''}`;
    container.appendChild(div);
  });
  el.appendChild(container);
}

/* ======= Messaging (simple) ======= */
function startMessage(toUser){
  if(!state.users[toUser]) return alert('User not found');
  const convoId = [currentUser, toUser].sort().join('__');
  state.messages[convoId] = state.messages[convoId] || [];
  appRoot.innerHTML = `
    <div style="max-width:900px; margin:20px auto;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Conversation with ${state.users[toUser].meta.profileName || toUser}</h3>
          <div><button class="btn" id="backHome2">Back</button></div>
        </div>
        <div id="msgArea" style="height:300px; overflow:auto; margin-top:10px; border:1px solid #eee; padding:8px; border-radius:8px; background:#fafafa"></div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <input id="msgInput" style="flex:1"/>
          <button class="btn" id="sendMsgBtn">Send</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('backHome2').addEventListener('click', renderApp);
  document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
    const text = document.getElementById('msgInput').value.trim();
    if(!text) return;
    state.messages[convoId].push({from:currentUser, text, ts:Date.now()});
    saveState(state);
    renderMessages(convoId);
    document.getElementById('msgInput').value='';
  });
  renderMessages(convoId);
}
function renderMessages(convoId){
  const arr = state.messages[convoId]||[];
  const area = document.getElementById('msgArea');
  area.innerHTML = '';
  arr.forEach(m=>{
    const div = document.createElement('div');
    div.style.marginBottom='8px';
    div.innerHTML = `<div style="font-size:13px" class="${m.from===currentUser?'':'muted'}"><strong>${m.from}</strong> <span class="small muted">${new Date(m.ts).toLocaleTimeString()}</span></div><div>${escapeHtml(m.text)}</div>`;
    area.appendChild(div);
  });
  area.scrollTop = area.scrollHeight;
}

/* ======= Search users & groups ======= */
function searchUsersAndGroups(q){
  const users = Object.values(state.users).filter(u=>{
    const s = (u.meta.profileName||u.username||'').toLowerCase();
    return s.includes(q);
  });
  const groups = Object.values(state.groups).filter(g => g.name.toLowerCase().includes(q));
  appRoot.innerHTML = `
    <div style="max-width:900px; margin:20px auto;">
      <div style="display:flex; justify-content:space-between; align-items:center;"><h3>Search results for "${q}"</h3><button class="btn" id="backRes">Back</button></div>
      <div class="card">
        <h4>People</h4>
        <div id="srUsers"></div>
        <hr/>
        <h4>Groups</h4>
        <div id="srGroups"></div>
      </div>
    </div>
  `;
  document.getElementById('backRes').addEventListener('click', renderApp);
  const su = document.getElementById('srUsers');
  users.forEach(u=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0';
    div.innerHTML = `<div>${u.meta.profileName || u.username}</div><div><button class="btn" onclick="renderProfilePage('${u.username}')">View</button></div>`;
    su.appendChild(div);
  });
  const sg = document.getElementById('srGroups');
  groups.forEach(g=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0';
    div.innerHTML = `<div>${g.name} <span class="small muted">(${g.members.length} members)</span></div><div><button class="btn" onclick="openGroup('${g.id}')">Open</button></div>`;
    sg.appendChild(div);
  });
}

/* ======= Helpers ======= */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

window.addEventListener('load', ()=>{
  // replace base64 placeholder if present in HTML
  const logoImg = document.getElementById('logoImg');
  if(logoImg && logoImg.src.indexOf('/*BASE64_LOGO*/')>-1){
    // already set above automatically
  }
  // If user logged in and profile incomplete, show setup
  if(currentUser){
    const meta = state.users[currentUser].meta;
    if(!meta.profileName || !meta.firstName || !meta.lastName || !meta.birthday){
      renderProfileSetup();
      return;
    }
    renderApp();
  } else {
    renderAuth();
  }
});

/* ======= Quick API to allow other inline onclick access (used earlier) ======= */
window.renderProfilePage = renderProfilePage;
window.openGroup = openGroup;
window.requestJoin = requestJoin;
window.sendFriendRequest = sendFriendRequest;
window.startMessage = startMessage;

</script>

<!-- Replace the placeholder base64 in the logo img src with the real base64; the generator already inserted it.
     If saving manually, paste the full base64 string (very long) between data:image/jpeg;base64, and the closing quote. -->

</body>
</html>



